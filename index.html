<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cyber Security Bot</title>
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            fontFamily: { sans: ['Inter', 'sans-serif'] },
            colors: {
              cyber: {
                dark: '#0f172a',
                light: '#1e293b',
                accent: '#00ff41', // Matrix Green
                text: '#e2e8f0'
              }
            }
          },
        },
      }
    </script>
    
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1"
      }
    }
    </script>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </head>
  
  <body class="bg-gray-900 text-gray-100 h-screen flex flex-col">
    <div id="root" class="h-full"></div>

    <script type="text/babel" data-type="module">
      import React, { useState, useEffect, useRef } from 'react';
      import { createRoot } from 'react-dom/client';
      import { Shield, Send, Terminal, AlertTriangle } from 'lucide-react';

      // --- CONFIGURATION ---
      // REPLACE THIS WITH YOUR ACTUAL RENDER URL
      const BACKEND_URL = "https://rag-app-woli.onrender.com/chat"; 

      function App() {
        const [messages, setMessages] = useState([
          { id: 1, text: "System Online. I am your Cyber Security Assistant. Ready for analysis.", sender: 'bot' }
        ]);
        const [input, setInput] = useState('');
        const [isLoading, setIsLoading] = useState(false);
        const messagesEndRef = useRef(null);

        // Auto-scroll to bottom
        const scrollToBottom = () => {
          messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
        };
        useEffect(scrollToBottom, [messages]);

        const sendMessage = async (e) => {
          e.preventDefault();
          if (!input.trim()) return;

          // 1. Add User Message
          const userMsg = { id: Date.now(), text: input, sender: 'user' };
          setMessages(prev => [...prev, userMsg]);
          setInput('');
          setIsLoading(true);

          try {
            // 2. Call Backend
            const response = await fetch(BACKEND_URL, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ query: input })
            });

            const data = await response.json();
            
            // 3. Add Bot Message
            setMessages(prev => [...prev, { 
              id: Date.now() + 1, 
              text: data.answer || "Error: No response from security core.", 
              sender: 'bot' 
            }]);

          } catch (error) {
            setMessages(prev => [...prev, { 
              id: Date.now() + 1, 
              text: "CRITICAL ERROR: Connection to server failed.", 
              sender: 'bot',
              isError: true 
            }]);
          } finally {
            setIsLoading(false);
          }
        };

        return (
          <div className="flex flex-col h-full max-w-4xl mx-auto p-4">
            {/* Header */}
            <div className="flex items-center gap-3 p-4 bg-slate-800 rounded-t-lg border-b border-slate-700">
              <div className="bg-green-500/10 p-2 rounded-full">
                <Shield className="w-6 h-6 text-green-400" />
              </div>
              <div>
                <h1 className="font-semibold text-lg text-white">CyberSentinel AI</h1>
                <div className="flex items-center gap-2 text-xs text-green-400">
                  <span className="relative flex h-2 w-2">
                    <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                    <span className="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
                  </span>
                  System Operational
                </div>
              </div>
            </div>

            {/* Chat Area */}
            <div className="flex-1 overflow-y-auto bg-slate-900 border-x border-slate-700 p-4 space-y-4">
              {messages.map((msg) => (
                <div key={msg.id} className={`flex ${msg.sender === 'user' ? 'justify-end' : 'justify-start'}`}>
                  <div className={`max-w-[80%] rounded-lg p-3 ${
                    msg.sender === 'user' 
                      ? 'bg-blue-600 text-white' 
                      : msg.isError 
                        ? 'bg-red-900/50 border border-red-500 text-red-200' 
                        : 'bg-slate-800 border border-slate-700 text-gray-200'
                  }`}>
                    {msg.sender === 'bot' && !msg.isError && (
                      <Terminal className="w-4 h-4 mb-1 text-green-500 inline-block mr-2" />
                    )}
                    {msg.text}
                  </div>
                </div>
              ))}
              
              {isLoading && (
                <div className="flex justify-start">
                  <div className="bg-slate-800 border border-slate-700 rounded-lg p-3 text-green-400 text-sm animate-pulse">
                    Scanning database...
                  </div>
                </div>
              )}
              <div ref={messagesEndRef} />
            </div>

            {/* Input Area */}
            <div className="bg-slate-800 p-4 rounded-b-lg border-t border-slate-700">
              <form onSubmit={sendMessage} className="flex gap-2">
                <input
                  type="text"
                  value={input}
                  onChange={(e) => setInput(e.target.value)}
                  placeholder="Enter command or query..."
                  className="flex-1 bg-slate-900 border border-slate-600 rounded-md px-4 py-2 text-white focus:outline-none focus:border-green-500 focus:ring-1 focus:ring-green-500 transition-all font-mono text-sm"
                />
                <button 
                  type="submit" 
                  disabled={isLoading}
                  className="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                >
                  <Send className="w-5 h-5" />
                </button>
              </form>
            </div>
          </div>
        );
      }

      // Render the App
      const root = createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>
